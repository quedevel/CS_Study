# IOCP

Created: May 2, 2023 6:33 PM

### IOCP란?

![Untitled](IOCP%200459875ad22841f18ddb2b4ec011a0b9/Untitled.png)

- Windows 운영 체제에서 비동기적인 I/O 작업을 처리하는 방식 중 하나
(Window 환경에서 작동하는 가장 흔하게 쓰이는 논블로킹 프로세스)
- Input/Output Completion Port의 약자 
(=입력과 출력의 완료를 담당할 포트를 지정해서 처리하겠다는 의미)
쉽게 말해 윈도우에서 제공하는 비동기 IO 라이브러리로 생각하면 됨
* port = 작업/서비스를 전담하기 위해서 만들어지는 객체
- 멀티 스레드와 같이 사용되는 방법으로 
사용할 스레드를 미리 만들어 놓고 소켓에서의 input/output이 완료되었을 때 잠들어있는 스레드를 깨워서 처리하는 방식
(보통 가장 최적화 할 수 있는 스레드의 수는 프로세서 수의 2배정도가 적당하다고 알려져 있음)
    1. 입출력 장치(소켓)로 부터 입출력이 완료됨
    2. 완료보고는 입출력 완료 대기열에 쌓임
    3. 작업 완료를 알리기 위해 스레드를 깨우게 되고
    4. 스레드는 대기열에 있는 완료 보고를 읽어서 데이터를 처리
- 입출력 작업이 완료될 때까지 기다리는 대신, 
대기열에 작업을 추가하고 다른 작업을 처리하도록 스레드를 반환할 수 있음
그리고 나서 작업이 완료되면 해당 작업에 대한 콜백이 호출되어 처리 가능
⇒ 동시성이 높은 환경에서도 빠르고 효율적인 I/O 처리 가능
- 동시에 수행되는 스레드의 상한을 설정해서 CPU의 자원을 최대한 효율적으로 사용하게 함
- 대량의 I/O 요청을 처리할 때 효율적이며, 
다수의 스레드를 사용하지 않아도 대량의 I/O 요청을 처리할 수 있도록 설계됨
- 입/출력의 완료시점에서의 통지는 overlapped(중첩 입출력)에서 처리가 되므로, 
윈도우의 중첩 입출력 기술을 확장시킨 것으로 볼 수 있음

### 탄생 배경

- 기존의 I/O 처리 방식 = 비동기 I/O와 select() 함수를 사용하는 방식
대량의 I/O 요청을 처리할 때 문제 발생
⇒
반복적으로 select() 함수를 호출하고 그 결과를 처리하는 방식으로 구현되어 있었기 때문에, 
처리할 요청의 수가 증가하면 그만큼 호출 횟수가 늘어나고 처리 속도가 저하됨
또한 다중 스레드를 사용해야 했기 때문에 스레드 관리 부담이 커짐
- IOCP는 새로운 I/O 모델을 제공함. 
비동기 I/O를 사용하는 것과 비슷하지만 select() 함수를 사용하지 않음.

소켓 버퍼에 대한 데이터 복사를 최소화하고, 
입출력 작업 완료 시 notification mechanism을 사용하여 스레드를 효율적으로 사용할 수 있음

IOCP를 사용하는 스레드는 I/O 완료를 기다리는 대기열에서 대기하다가 I/O 완료 시 이벤트를 받아 처리하는 방식.
⇒ 적은 수의 스레드를 사용하면서도 대량의 I/O 요청을 처리할 수 있도록 설계됨
- 운영 체제 수준에서 I/O 요청과 I/O 완료 이벤트를 관리하므로
애플리케이션에서는 완료 이벤트에 대한 처리만 신경쓰면 됨
⇒ I/O 처리를 위한 복잡한 로직을 작성할 필요 없어지며 I/O 처리 속도 향상됨

### 특징

1. I/O 완료 이벤트 대기열
    
    IOCP를 사용하는 스레드는 I/O 완료 이벤트를 받기 위해 대기열에서 대기함
    이때, 애플리케이션이 요청한 I/O 작업이 완료되면 운영 체제는 해당 스레드에게 I/O 완료 이벤트를 보내고, 
    해당 스레드는 이벤트를 처리함
    
2. 스레드 풀
    
    IOCP는 스레드 풀을 사용하여 스레드를 관리함
    이를 통해 I/O 완료 이벤트를 처리하는 스레드를 관리하면서도, 
    스레드 수를 제한하고 CPU 사용률을 효율적으로 유지할 수 있음
    
    - 스레드 풀링 (Thread pooling)
        - 작업 처리를 위해 필요한 스레드들을 미리 생성해 놓고, 
        작업 처리가 요청되면 생성된 스레드를 가져가 사용한 뒤 다시 반납하는 방식
        - 스레드를 생성하는 것은 오버헤드가 큰 작업이기 때문에, 
        스레드 풀링을 사용하면 스레드 생성에 따른 부하를 줄일 수 있으며 
        스레드 생성과 소멸에 의한 지연 시간을 없애고, 
        생성된 스레드들을 재활용하여 자원을 효율적으로 사용할 수 있음
        - 스레드 풀링은 주로 I/O 작업을 처리하는 서버에서 사용됨
        ex) 
        웹 서버에서 클라이언트 요청에 대한 응답을 처리할 때, 각각의 요청마다 스레드를 생성하는 것 
        ⇒ 시스템 자원을 낭비할 뿐만 아니라 응답 시간도 늘릴 수 있음. 
        
        스레드 풀링을 사용해 미리 생성된 스레드를 이용해 요청을 처리하면
        자원을 효율적으로 사용할 수 있으며 처리 속도도 빨라질 수 있음
        
3. 대기열 개수 제한
    
    IOCP는 대기열 개수를 제한함으로써, 애플리케이션이 동시에 처리할 수 있는 I/O 요청 수를 제한함.
    이를 통해 애플리케이션이 과도한 메모리 사용을 방지하고, 안정적인 성능을 유지할 수 있음
    
4. 비동기 I/O
IOCP는 비동기 I/O 모델을 사용.
이는 I/O 요청을 호출한 스레드가 대기하지 않고, 다른 작업을 진행할 수 있도록 해주는 방식
이를 통해 I/O 작업의 처리 속도를 향상시키고, 블로킹 상태를 방지할 수 있음
5. 다양한 I/O 타입 지원
IOCP는 파일, 소켓 등 다양한 I/O 타입을 지원하며 다른 운영 체제와 호환성을 유지할 수 있음

### 기본적인 구동 방식

- 동작 원리
    
    아래 과정을 통해 IOCP는 비동기 입출력 작업을 처리함.
    애플리케이션은 블로킹되지 않고, 다른 작업을 수행하면서도 비동기 입출력 작업을 효율적으로 처리 가능해짐
    
    1. I/O 요청 등록
        - 애플리케이션이 비동기 입출력을 요청할 때, IOCP 객체를 통해 해당 요청을 등록함
        - 등록된 요청은 커널 내부의 I/O 완료 포트에 저장됨
    2. I/O 완료 대기
        - IOCP 객체는 커널 내부의 I/O 완료 포트와 연결되어 있으며, 대기 상태에 있음
        - 커널은 I/O 작업이 완료될 때마다 해당 작업의 결과를 I/O 완료 포트에 등록함
    3. I/O 완료 처리
        - IOCP 객체는 I/O 완료 포트에 등록된 작업 결과를 확인하고, 해당 작업의 결과를 처리함
        - 처리할 작업이 많다면 스레드 풀에서 추가적인 스레드를 생성하여 작업을 처리함
    4. 처리 결과 반환
        - 작업 처리 결과는 애플리케이션으로 반환됨
        - 작업이 성공적으로 완료된 경우에는 해당 작업의 결과를 반환하고, 실패한 경우에는 실패 이유를 반환함

- IOCP를 사용한 비동기 소켓 프로그래밍 과정
    1. 적당한 개수의 워커 스레드를 생성함 
    이때 워커 스레드는 IOCP 작업 완료를 기다리는 역할을 함
    2. 소켓을 생성
    3. 클라이언트가 접속하면 accept 함수를 호출하여 연결을 수락함
    4. 연결이 완료되면 해당 소켓을 IOCP에 등록함
    이때, IOCP 객체는 completion port라는 개념을 사용함
    5. 입출력 작업을 수행하기 위해 WSARecv 함수를 호출함
    이때, 입출력이 완료되면 해당 작업을 completion queue에 등록하고, 워커 스레드에 할당함

### 장단점

### 장점

1. 적은 수의 스레드 사용으로 CPU 점유율도 낮으며 context switching 비용 적음
⇒ 윈도우 OS가 직접 스레드 풀링을 관리하므로
사용자 수준에서 비동기 입출력 작업을 처리하는 것보다 커널 수준에서 처리하는 것이 더욱 효과적
2. 스레드 풀을 이용해 스레드를 관리하므로, 스레드 생성 및 삭제와 같은 오버헤드를 줄일 수 있음
3. Overrapped I/O를 확장 시킨 개념이기 때문에 커널영역과 유저영역의 버퍼를 공유함
4. 비동기 I/O 처리
    
    IOCP는 비동기 입출력 처리를 지원하므로 입출력 작업이 완료될 때까지 기다리지 않고 다른 작업 처리 가능
    ⇒ 더 높은 처리량을 달성 가능
    
5. 높은 확장성
    
    IOCP는 여러 개의 쓰레드를 사용하여 입출력 작업을 동시에 처리할 수 있음
    ⇒ 더 높은 확장성을 가질 수 있음
    
6. I/O 우선순위 지정
    
    IOCP는 I/O 우선순위를 지정하여, 중요한 입출력 작업을 먼저 처리할 수 있음
    
7. 멀티플렉싱 지원
    
    IOCP는 여러 개의 소켓을 동시에 처리할 수 있음
    이를 통해 애플리케이션은 더 높은 처리량을 달성할 수 있음
    
8. 메모리 절약 및 빠른 처리
    
    IOCP는 커널 버퍼를 직접 사용하므로, 사용자 버퍼를 복사할 필요가 없음
    ⇒ 메모리를 절약하고, 빠른 처리 속도를 가질 수 있음
    

### 단점

1. 복잡한 구현
    
    IOCP는 비동기 입출력 처리를 위한 복잡한 구현이 필요함
    ⇒ IOCP 모델을 이해하고, 적절한 쓰레드 개수, 버퍼 크기 등을 설정해줘야함
    
2. 윈도우 전용
    
    IOCP는 윈도우 운영체제에서만 지원됨 
    ⇒ 애플리케이션이 윈도우 운영체제에서 동작할 경우에만 사용할 수 있음
    
3. 쓰레드 안정성
    
    IOCP는 여러 개의 쓰레드를 사용하기 때문에, 쓰레드 간의 동기화와 관련된 문제가 발생할 수 있음
    이를 위해 쓰레드 간의 동기화를 신경써 구현해줘야 함
    
4. 복잡한 디버깅
    
    IOCP를 사용한 코드는 복잡하고 디버깅이 어렵기 때문에 개발자가 충분한 경험이 필요함
    ⇒ 디버깅이 쉽지 않아, 예기치 않은 오류가 발생할 가능성이 있음
    

### 활용되는 분야

- 비동기 입출력 작업을 처리하는 네트워크 애플리케이션에서 효과적으로 사용됨
다수의 클라이언트와의 통신을 효율적으로 처리 가능
- 특히 대용량 네트워크 어플리케이션 및 서버에 유용
ex) 게임 서버, 웹 서버, 메신저, 파일 전송 서버 등
- 위와 같은 게임 서버, 웹 서버, 메신저, 파일 전송 서버는
다수의 클라이언트와 동시에 연결되어 처리해야하는 입출력이 많이 발생함
이때, IOCP 기술 사용해서 얻을 수 있는 이점은 아래와 같음
    1. 비동기적인 작업 처리
    IOCP는 비동기 입출력 작업을 수행하기 때문에, 입출력 작업이 완료될 때까지 스레드를 대기시키지 않고 다른 작업을 처리함
    이를 통해 다수의 입출력 작업을 동시에 처리 가능
    2. 스레드 풀 사용
    IOCP는 다수의 스레드를 사용하여 작업을 처리하기 때문에, 스레드 풀을 효율적으로 활용할 수 있음 
    이를 통해 스레드 생성 및 소멸에 따른 오버헤드를 줄일 수 있음
    3. 데이터 전송 효율성
    IOCP는 입출력 작업을 패킷 단위로 처리하기 때문에, 데이터 전송 효율성이 높음
    이를 통해 대용량 데이터 전송 및 동시 접속 처리에 대한 부하를 효과적으로 처리할 수 있음
    4. 확장성
    IOCP는 Windows 운영 체제의 코어 커널과 밀접하게 연관되어 있어서, 확장성이 높음 
    따라서 대규모 서버 시스템에서도 안정적으로 동작할 수 있음